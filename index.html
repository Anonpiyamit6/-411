<!doctype html>
<html lang="th">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏≠‡∏á‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô 411</title>
  <script src="/_sdk/element_sdk.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      box-sizing: border-box;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    @keyframes slideIn {
      from { opacity: 0; transform: translateX(-20px); }
      to { opacity: 1; transform: translateX(0); }
    }
    
    .fade-in {
      animation: fadeIn 0.3s ease-out;
    }
    
    .slide-in {
      animation: slideIn 0.4s ease-out;
    }
    
    .booking-card {
      transition: all 0.3s ease;
    }
    
    .booking-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
    }
    
    .status-available {
      background: linear-gradient(135deg, #d4f4dd 0%, #a8e6cf 100%);
      border-left: 4px solid #4ade80;
    }
    
    .status-booked {
      background: linear-gradient(135deg, #ffd4d4 0%, #ffb3b3 100%);
      border-left: 4px solid #ef4444;
    }

    .tab-button {
      transition: all 0.3s ease;
    }

    .tab-button.active {
      border-bottom: 3px solid;
    }

    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    @media print {
      body * {
        visibility: hidden;
      }
      .print-area, .print-area * {
        visibility: visible;
      }
      .print-area {
        position: absolute;
        left: 0;
        top: 0;
        width: 100%;
      }
    }
  </style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
 </head>
 <body class="w-full min-h-full">
  <div id="app" class="w-full min-h-full"></div>
  <script>
    // Configuration
    const defaultConfig = {
      system_title: '‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏≠‡∏á‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô 411',
      login_title: '‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö',
      teacher_dashboard_title: '‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î‡∏Ñ‡∏£‡∏π',
      admin_dashboard_title: '‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô',
      primary_color: '#a7c7e7',
      secondary_color: '#ffffff',
      text_color: '#1f2937',
      action_color: '#60a5fa',
      accent_color: '#f59e0b',
      font_family: 'Kanit',
      font_size: 16
    };

    // Default periods
    const DEFAULT_PERIODS = [
      { name: '‡∏Ñ‡∏≤‡∏ö 1', time: '08:00-09:00' },
      { name: '‡∏Ñ‡∏≤‡∏ö 2', time: '09:00-10:00' },
      { name: '‡∏Ñ‡∏≤‡∏ö 3', time: '10:00-11:00' },
      { name: '‡∏Ñ‡∏≤‡∏ö 4', time: '11:00-12:00' },
      { name: '‡∏Ñ‡∏≤‡∏ö 5', time: '13:00-14:00' },
      { name: '‡∏Ñ‡∏≤‡∏ö 6', time: '14:00-15:00' },
      { name: '‡∏Ñ‡∏≤‡∏ö 7', time: '15:00-16:00' },
      { name: '‡∏Ñ‡∏≤‡∏ö 8', time: '16:00-17:00' }
    ];

    // Admin credentials
    const ADMIN_USERNAME = 'admin';
    const ADMIN_PASSWORD = 'admin123';

    // State
    let currentUser = null;
    let currentRole = null;
    let allData = [];
    let isLoading = false;
    let currentAdminTab = 'bookings';

    // Helper functions
    function getTeachers() {
      return allData.filter(d => d.type === 'teacher');
    }

    function getBookings() {
      return allData.filter(d => d.type === 'booking');
    }

    // [‡πÄ‡∏û‡∏¥‡πà‡∏°] Helper ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏™‡∏≠‡∏ô‡∏õ‡∏£‡∏∞‡∏à‡∏≥
    function getFixedSchedules() {
      return allData.filter(d => d.type === 'fixed_schedule');
    }

    function getPeriods() {
      const periods = allData.filter(d => d.type === 'period');
      if (periods.length === 0) return DEFAULT_PERIODS.map((p, i) => ({ ...p, id: `default-${i}` }));
      return periods.map(p => ({ 
        id: String(p.period_id || p.id), 
        name: p.period_name, 
        time: p.period_time 
      }));
    }

    function getFormattedPeriod(period) {
      return `${period.name} (${period.time})`;
    }

    // Google Apps Script Configuration
    const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycby_FvjwL_N4OTK82vVB4w9Hwuelrr_kVssS4VSdpT85usjEQwtrhxO0bTLjBwrIXD21xA/exec';

    // JSONP callback handlers
    window.jsonpCallbacks = {};
    let callbackCounter = 0;

    // JSONP request function
    function jsonpRequest(url, params = {}) {
      return new Promise((resolve, reject) => {
        const callbackName = `jsonpCallback${callbackCounter++}`;
        const script = document.createElement('script');
        
        window.jsonpCallbacks[callbackName] = (data) => {
          delete window.jsonpCallbacks[callbackName];
          document.body.removeChild(script);
          resolve(data);
        };

        const queryParams = new URLSearchParams({
          ...params,
          callback: `jsonpCallbacks.${callbackName}`
        }).toString();

        script.src = `${url}?${queryParams}`;
        script.onerror = () => {
          delete window.jsonpCallbacks[callbackName];
          document.body.removeChild(script);
          reject(new Error('JSONP request failed'));
        };

        document.body.appendChild(script);

        setTimeout(() => {
          if (window.jsonpCallbacks[callbackName]) {
            delete window.jsonpCallbacks[callbackName];
            if (document.body.contains(script)) {
              document.body.removeChild(script);
            }
            reject(new Error('JSONP request timeout'));
          }
        }, 30000);
      });
    }

    // Google Sheets API functions
    async function loadDataFromSheets() {
      try {
        const response = await jsonpRequest(APPS_SCRIPT_URL, {
          action: 'getData'
        });
        
        if (response.success) {
          allData = response.data || [];
          if (currentRole) {
            renderDashboard();
          }
        } else {
          console.error('Failed to load data:', response.error);
          showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', 'error');
        }
      } catch (error) {
        console.error('Error loading data:', error);
        showToast('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö Google Sheets', 'error');
      }
    }

    async function refreshData() {
      if (isLoading) return;
      const btn = document.getElementById('refreshBtn');
      if(btn) {
        btn.disabled = true;
        btn.innerHTML = 'üîÑ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...';
      }
      
      showToast('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î...', 'info');
      await loadDataFromSheets();
      showToast('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏õ‡πá‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡πÅ‡∏•‡πâ‡∏ß');
      
      if(btn) {
        btn.disabled = false;
        btn.innerHTML = 'üîÑ ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä';
      }
    }

    async function saveDataToSheets(record) {
      try {
        const response = await jsonpRequest(APPS_SCRIPT_URL, {
          action: 'createData',
          data: JSON.stringify(record)
        });
        
        if (response.success) {
          await loadDataFromSheets();
          return { isOk: true };
        } else {
          return { isOk: false, error: response.error };
        }
      } catch (error) {
        console.error('Error saving data:', error);
        return { isOk: false, error: error.message };
      }
    }

    async function updateDataInSheets(record) {
      try {
        const response = await jsonpRequest(APPS_SCRIPT_URL, {
          action: 'updateData',
          data: JSON.stringify(record)
        });
        
        if (response.success) {
          await loadDataFromSheets();
          return { isOk: true };
        } else {
          return { isOk: false, error: response.error };
        }
      } catch (error) {
        console.error('Error updating data:', error);
        return { isOk: false, error: error.message };
      }
    }

    async function deleteDataFromSheets(record) {
      try {
        let idToDelete = record.__backendId || record.period_id || record.teacher_id || record.booking_id || record.id;
        
        const response = await jsonpRequest(APPS_SCRIPT_URL, {
          action: 'deleteData',
          id: idToDelete
        });
        
        if (response.success) {
          await loadDataFromSheets();
          return { isOk: true };
        } else {
          return { isOk: false, error: response.error };
        }
      } catch (error) {
        console.error('Error deleting data:', error);
        return { isOk: false, error: error.message };
      }
    }

    async function initializeDataSDK() {
      await loadDataFromSheets();
      setInterval(loadDataFromSheets, 30000);
    }

    function showToast(message, type = 'success') {
      const toast = document.createElement('div');
      const bgColor = type === 'success' ? '#4ade80' : (type === 'info' ? '#60a5fa' : '#ef4444');
      toast.className = 'fixed top-4 right-4 px-6 py-4 rounded-lg shadow-lg text-white fade-in z-50';
      toast.style.background = bgColor;
      toast.style.fontSize = `${window.elementSdk?.config?.font_size || defaultConfig.font_size}px`;
      toast.style.fontFamily = `${window.elementSdk?.config?.font_family || defaultConfig.font_family}, sans-serif`;
      toast.textContent = message;
      document.body.appendChild(toast);
      setTimeout(() => {
        toast.style.opacity = '0';
        setTimeout(() => toast.remove(), 300);
      }, 3000);
    }

    // [‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç] Check for booking conflicts (‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö Fixed Schedule)
    function checkConflict(date, period, labName, excludeId = null) {
      // 1. ‡πÄ‡∏ä‡πá‡∏Ñ Fixed Schedule
      const dateObj = new Date(date);
      const dayNames = ['‡∏≠‡∏≤', '‡∏à', '‡∏≠', '‡∏û', '‡∏û‡∏§', '‡∏®', '‡∏™'];
      const currentDayName = dayNames[dateObj.getDay()];

      const fixedSchedule = getFixedSchedules().find(s => 
        s.day_name === currentDayName && 
        s.period_name === period
      );

      if (fixedSchedule) {
        return { 
          teacher_name: '‡∏Ñ‡∏£‡∏π‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏´‡πâ‡∏≠‡∏á (‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏™‡∏≠‡∏ô)', 
          experiment_name: fixedSchedule.description || '‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ô'
        };
      }

      // 2. ‡πÄ‡∏ä‡πá‡∏Ñ‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏õ‡∏Å‡∏ï‡∏¥
      return getBookings().find(booking => 
        booking.__backendId !== excludeId &&
        booking.date === date &&
        booking.period === period &&
        booking.lab_name === labName
      );
    }

    function showModal(content) {
      const modal = document.createElement('div');
      modal.className = 'modal-overlay fade-in';
      modal.innerHTML = content;
      modal.onclick = (e) => {
        if (e.target === modal) {
          modal.remove();
        }
      };
      document.body.appendChild(modal);
      return modal;
    }

    function closeModal() {
      const modal = document.querySelector('.modal-overlay');
      if (modal) modal.remove();
    }

    // Period management functions
    function showAddPeriodModal() {
      const config = window.elementSdk?.config || defaultConfig;
      const modal = showModal(`
        <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full mx-4 slide-in">
          <h2 class="text-2xl font-bold mb-6" style="color: ${config.text_color}; font-family: ${config.font_family}, sans-serif; font-size: ${config.font_size * 1.5}px;">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏≤‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÉ‡∏´‡∏°‡πà</h2>
          <form id="addPeriodForm" class="space-y-4">
            <div>
              <label class="block text-gray-700 mb-2 font-medium" style="font-family: ${config.font_family}, sans-serif; font-size: ${config.font_size}px;">‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏≤‡∏ö</label>
              <input type="text" id="periodName" required placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏Ñ‡∏≤‡∏ö 1" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2" style="font-family: ${config.font_family}, sans-serif; font-size: ${config.font_size}px; border-color: ${config.action_color};">
            </div>
            <div>
              <label class="block text-gray-700 mb-2 font-medium" style="font-family: ${config.font_family}, sans-serif; font-size: ${config.font_size}px;">‡πÄ‡∏ß‡∏•‡∏≤</label>
              <input type="text" id="periodTime" required placeholder="‡πÄ‡∏ä‡πà‡∏ô 08:00-09:00" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2" style="font-family: ${config.font_family}, sans-serif; font-size: ${config.font_size}px; border-color: ${config.action_color};">
            </div>
            <div class="flex gap-3 mt-6">
              <button type="button" onclick="closeModal()" class="flex-1 py-3 px-6 rounded-lg font-semibold bg-gray-300 text-gray-700 hover:bg-gray-400 transition-all" style="font-family: ${config.font_family}, sans-serif; font-size: ${config.font_size}px;">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
              <button type="submit" class="flex-1 py-3 px-6 rounded-lg font-semibold text-white transition-all hover:shadow-lg" style="background: ${config.action_color}; font-family: ${config.font_family}, sans-serif; font-size: ${config.font_size}px;">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏≤‡∏ö</button>
            </div>
          </form>
        </div>
      `);

      document.getElementById('addPeriodForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        if (isLoading || allData.length >= 999) {
          showToast('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏≤‡∏ö‡πÑ‡∏î‡πâ ‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏≤‡∏Å‡∏ñ‡∏∂‡∏á‡∏Ç‡∏µ‡∏î‡∏à‡∏≥‡∏Å‡∏±‡∏î‡πÅ‡∏•‡πâ‡∏ß', 'error');
          return;
        }
        const name = document.getElementById('periodName').value;
        const time = document.getElementById('periodTime').value;
        isLoading = true;
        const submitBtn = e.target.querySelector('button[type="submit"]');
        submitBtn.disabled = true;
        submitBtn.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°...';
        const result = await saveDataToSheets({
          type: 'period',
          period_id: Date.now().toString(),
          period_name: name,
          period_time: time,
          created_at: new Date().toISOString()
        });
        isLoading = false;
        if (result.isOk) {
          showToast('‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏≤‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!');
          closeModal();
        } else {
          showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏≤‡∏ö', 'error');
          submitBtn.disabled = false;
          submitBtn.textContent = '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏≤‡∏ö';
        }
      });
    }

    function showEditPeriodModal(periodId) {
      const config = window.elementSdk?.config || defaultConfig;
      const periodData = allData.find(d => d.type === 'period' && String(d.period_id || d.id) === String(periodId));
      if (!periodData) {
        showToast('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏≤‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ô', 'error');
        return;
      }
      const modal = showModal(`
        <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full mx-4 slide-in">
          <h2 class="text-2xl font-bold mb-6" style="color: ${config.text_color}; font-family: ${config.font_family}, sans-serif; font-size: ${config.font_size * 1.5}px;">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ñ‡∏≤‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h2>
          <form id="editPeriodForm" class="space-y-4">
            <div>
              <label class="block text-gray-700 mb-2 font-medium" style="font-family: ${config.font_family}, sans-serif; font-size: ${config.font_size}px;">‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏≤‡∏ö</label>
              <input type="text" id="editPeriodName" value="${periodData.period_name}" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2" style="font-family: ${config.font_family}, sans-serif; font-size: ${config.font_size}px; border-color: ${config.action_color};">
            </div>
            <div>
              <label class="block text-gray-700 mb-2 font-medium" style="font-family: ${config.font_family}, sans-serif; font-size: ${config.font_size}px;">‡πÄ‡∏ß‡∏•‡∏≤</label>
              <input type="text" id="editPeriodTime" value="${periodData.period_time}" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2" style="font-family: ${config.font_family}, sans-serif; font-size: ${config.font_size}px; border-color: ${config.action_color};">
            </div>
            <div class="flex gap-3 mt-6">
              <button type="button" onclick="closeModal()" class="flex-1 py-3 px-6 rounded-lg font-semibold bg-gray-300 text-gray-700 hover:bg-gray-400 transition-all" style="font-family: ${config.font_family}, sans-serif; font-size: ${config.font_size}px;">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
              <button type="submit" class="flex-1 py-3 px-6 rounded-lg font-semibold text-white transition-all hover:shadow-lg" style="background: ${config.action_color}; font-family: ${config.font_family}, sans-serif; font-size: ${config.font_size}px;">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
            </div>
          </form>
        </div>
      `);
      document.getElementById('editPeriodForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        if (isLoading) return;
        const name = document.getElementById('editPeriodName').value;
        const time = document.getElementById('editPeriodTime').value;
        isLoading = true;
        const submitBtn = e.target.querySelector('button[type="submit"]');
        submitBtn.disabled = true;
        submitBtn.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';
        const updatedPeriod = {
          ...periodData,
          period_name: name,
          period_time: time,
          period_id: periodData.period_id || periodData.id
        };
        const result = await updateDataInSheets(updatedPeriod);
        isLoading = false;
        if (result.isOk) {
          showToast('‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ñ‡∏≤‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!');
          closeModal();
        } else {
          showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç', 'error');
          submitBtn.disabled = false;
          submitBtn.textContent = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å';
        }
      });
    }

    async function deletePeriod(periodId) {
      const periodData = allData.find(d => d.type === 'period' && String(d.period_id || d.id) === String(periodId));
      if (!periodData) {
        showToast('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏≤‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ô', 'error');
        return;
      }
      const modal = showModal(`
        <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full mx-4 slide-in">
          <h2 class="text-2xl font-bold mb-4 text-red-600" style="font-family: ${window.elementSdk?.config?.font_family || defaultConfig.font_family}, sans-serif;">‚ö†Ô∏è ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö</h2>
          <p class="mb-6" style="font-family: ${window.elementSdk?.config?.font_family || defaultConfig.font_family}, sans-serif; font-size: ${window.elementSdk?.config?.font_size || defaultConfig.font_size}px;">
            ‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ñ‡∏≤‡∏ö "${periodData.period_name} (${periodData.period_time})" ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?<br>
            <span class="text-red-500 font-semibold">‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏≥‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏î‡πâ</span>
          </p>
          <div class="flex gap-3">
            <button onclick="closeModal()" class="flex-1 py-3 px-6 rounded-lg font-semibold bg-gray-300 text-gray-700 hover:bg-gray-400 transition-all" style="font-family: ${window.elementSdk?.config?.font_family || defaultConfig.font_family}, sans-serif; font-size: ${window.elementSdk?.config?.font_size || defaultConfig.font_size}px;">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
            <button onclick="confirmDeletePeriod('${periodId}')" class="flex-1 py-3 px-6 rounded-lg font-semibold bg-red-500 text-white hover:bg-red-600 transition-all" style="font-family: ${window.elementSdk?.config?.font_family || defaultConfig.font_family}, sans-serif; font-size: ${window.elementSdk?.config?.font_size || defaultConfig.font_size}px;">‡∏•‡∏ö‡∏Ñ‡∏≤‡∏ö</button>
          </div>
        </div>
      `);
    }

    async function confirmDeletePeriod(periodId) {
      const periodData = allData.find(d => d.type === 'period' && String(d.period_id || d.id) === String(periodId));
      if (!periodData || isLoading) return;
      const confirmBtn = document.querySelector('.modal-overlay button.bg-red-500');
      if (confirmBtn) {
        confirmBtn.innerText = '‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡∏ö...';
        confirmBtn.disabled = true;
        confirmBtn.classList.add('opacity-50', 'cursor-not-allowed');
      }
      isLoading = true;
      if(!periodData.period_id && periodData.id) periodData.period_id = periodData.id;
      const result = await deleteDataFromSheets(periodData);
      isLoading = false;
      if (result.isOk) {
        showToast('‚úÖ ‡∏•‡∏ö‡∏Ñ‡∏≤‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!');
        closeModal();
      } else {
        showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö', 'error');
        if (confirmBtn) {
          confirmBtn.innerText = '‡∏•‡∏ö‡∏Ñ‡∏≤‡∏ö';
          confirmBtn.disabled = false;
          confirmBtn.classList.remove('opacity-50', 'cursor-not-allowed');
        }
      }
    }

    // Teacher management functions
    function showAddTeacherModal() {
      const config = window.elementSdk?.config || defaultConfig;
      const modal = showModal(`
        <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full mx-4 slide-in">
          <h2 class="text-2xl font-bold mb-6" style="color: ${config.text_color}; font-family: ${config.font_family}, sans-serif; font-size: ${config.font_size * 1.5}px;">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏£‡∏π‡πÉ‡∏´‡∏°‡πà</h2>
          <form id="addTeacherForm" class="space-y-4">
            <div>
              <label class="block text-gray-700 mb-2 font-medium" style="font-family: ${config.font_family}, sans-serif; font-size: ${config.font_size}px;">‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏£‡∏π</label>
              <input type="text" id="teacherName" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2" style="font-family: ${config.font_family}, sans-serif; font-size: ${config.font_size}px; border-color: ${config.action_color};">
            </div>
            <div>
              <label class="block text-gray-700 mb-2 font-medium" style="font-family: ${config.font_family}, sans-serif; font-size: ${config.font_size}px;">Username</label>
              <input type="text" id="teacherUsername" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2" style="font-family: ${config.font_family}, sans-serif; font-size: ${config.font_size}px; border-color: ${config.action_color};">
            </div>
            <div>
              <label class="block text-gray-700 mb-2 font-medium" style="font-family: ${config.font_family}, sans-serif; font-size: ${config.font_size}px;">Password</label>
              <input type="password" id="teacherPassword" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2" style="font-family: ${config.font_family}, sans-serif; font-size: ${config.font_size}px; border-color: ${config.action_color};">
            </div>
            <div class="flex gap-3 mt-6">
              <button type="button" onclick="closeModal()" class="flex-1 py-3 px-6 rounded-lg font-semibold bg-gray-300 text-gray-700 hover:bg-gray-400 transition-all" style="font-family: ${config.font_family}, sans-serif; font-size: ${config.font_size}px;">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
              <button type="submit" class="flex-1 py-3 px-6 rounded-lg font-semibold text-white transition-all hover:shadow-lg" style="background: ${config.action_color}; font-family: ${config.font_family}, sans-serif; font-size: ${config.font_size}px;">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏£‡∏π</button>
            </div>
          </form>
        </div>
      `);

      document.getElementById('addTeacherForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        if (isLoading || allData.length >= 999) {
          showToast('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏£‡∏π‡πÑ‡∏î‡πâ ‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏≤‡∏Å‡∏ñ‡∏∂‡∏á‡∏Ç‡∏µ‡∏î‡∏à‡∏≥‡∏Å‡∏±‡∏î‡πÅ‡∏•‡πâ‡∏ß', 'error');
          return;
        }
        const name = document.getElementById('teacherName').value;
        const username = document.getElementById('teacherUsername').value;
        const password = document.getElementById('teacherPassword').value;
        const existingTeacher = getTeachers().find(t => t.teacher_username === username);
        if (existingTeacher) {
          showToast('Username ‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß', 'error');
          return;
        }
        isLoading = true;
        const submitBtn = e.target.querySelector('button[type="submit"]');
        submitBtn.disabled = true;
        submitBtn.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°...';
        const result = await saveDataToSheets({
          type: 'teacher',
          teacher_id: Date.now().toString(),
          teacher_name: name,
          teacher_username: username,
          teacher_password: password,
          created_at: new Date().toISOString()
        });
        isLoading = false;
        if (result.isOk) {
          showToast('‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏£‡∏π‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!');
          closeModal();
        } else {
          showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏£‡∏π', 'error');
          submitBtn.disabled = false;
          submitBtn.textContent = '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏£‡∏π';
        }
      });
    }

    function showEditTeacherModal(teacher) {
      const config = window.elementSdk?.config || defaultConfig;
      const modal = showModal(`
        <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full mx-4 slide-in">
          <h2 class="text-2xl font-bold mb-6" style="color: ${config.text_color}; font-family: ${config.font_family}, sans-serif; font-size: ${config.font_size * 1.5}px;">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏£‡∏π</h2>
          <form id="editTeacherForm" class="space-y-4">
            <div>
              <label class="block text-gray-700 mb-2 font-medium" style="font-family: ${config.font_family}, sans-serif; font-size: ${config.font_size}px;">‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏£‡∏π</label>
              <input type="text" id="editTeacherName" value="${teacher.teacher_name}" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2" style="font-family: ${config.font_family}, sans-serif; font-size: ${config.font_size}px; border-color: ${config.action_color};">
            </div>
            <div>
              <label class="block text-gray-700 mb-2 font-medium" style="font-family: ${config.font_family}, sans-serif; font-size: ${config.font_size}px;">Username</label>
              <input type="text" id="editTeacherUsername" value="${teacher.teacher_username}" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2" style="font-family: ${config.font_family}, sans-serif; font-size: ${config.font_size}px; border-color: ${config.action_color};">
            </div>
            <div>
              <label class="block text-gray-700 mb-2 font-medium" style="font-family: ${config.font_family}, sans-serif; font-size: ${config.font_size}px;">Password ‡πÉ‡∏´‡∏°‡πà (‡πÄ‡∏ß‡πâ‡∏ô‡∏ß‡πà‡∏≤‡∏á‡∏´‡∏≤‡∏Å‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô)</label>
              <input type="password" id="editTeacherPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2" style="font-family: ${config.font_family}, sans-serif; font-size: ${config.font_size}px; border-color: ${config.action_color};">
            </div>
            <div class="flex gap-3 mt-6">
              <button type="button" onclick="closeModal()" class="flex-1 py-3 px-6 rounded-lg font-semibold bg-gray-300 text-gray-700 hover:bg-gray-400 transition-all" style="font-family: ${config.font_family}, sans-serif; font-size: ${config.font_size}px;">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
              <button type="submit" class="flex-1 py-3 px-6 rounded-lg font-semibold text-white transition-all hover:shadow-lg" style="background: ${config.action_color}; font-family: ${config.font_family}, sans-serif; font-size: ${config.font_size}px;">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
            </div>
          </form>
        </div>
      `);

      document.getElementById('editTeacherForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        if (isLoading) return;
        const name = document.getElementById('editTeacherName').value;
        const username = document.getElementById('editTeacherUsername').value;
        const password = document.getElementById('editTeacherPassword').value;
        const existingTeacher = getTeachers().find(t => 
          t.teacher_username === username && t.__backendId !== teacher.__backendId
        );
        if (existingTeacher) {
          showToast('Username ‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß', 'error');
          return;
        }
        isLoading = true;
        const submitBtn = e.target.querySelector('button[type="submit"]');
        submitBtn.disabled = true;
        submitBtn.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';
        const updatedTeacher = {
          ...teacher,
          teacher_name: name,
          teacher_username: username,
          teacher_id: teacher.teacher_id || teacher.id 
        };
        if (password) {
          updatedTeacher.teacher_password = password;
        }
        const result = await updateDataInSheets(updatedTeacher);
        isLoading = false;
        if (result.isOk) {
          showToast('‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏£‡∏π‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!');
          closeModal();
        } else {
          showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ' + (result.error || ''), 'error');
          submitBtn.disabled = false;
          submitBtn.textContent = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å';
        }
      });
    }

    async function deleteTeacher(teacher) {
      const modal = showModal(`
        <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full mx-4 slide-in">
          <h2 class="text-2xl font-bold mb-4 text-red-600" style="font-family: ${window.elementSdk?.config?.font_family || defaultConfig.font_family}, sans-serif;">‚ö†Ô∏è ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö</h2>
          <p class="mb-6" style="font-family: ${window.elementSdk?.config?.font_family || defaultConfig.font_family}, sans-serif; font-size: ${window.elementSdk?.config?.font_size || defaultConfig.font_size}px;">
            ‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ñ‡∏£‡∏π "${teacher.teacher_name}" ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?<br>
            <span class="text-red-500 font-semibold">‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏≥‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏î‡πâ</span>
          </p>
          <div class="flex gap-3">
            <button onclick="closeModal()" class="flex-1 py-3 px-6 rounded-lg font-semibold bg-gray-300 text-gray-700 hover:bg-gray-400 transition-all" style="font-family: ${window.elementSdk?.config?.font_family || defaultConfig.font_family}, sans-serif; font-size: ${window.elementSdk?.config?.font_size || defaultConfig.font_size}px;">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
            <button onclick="confirmDeleteTeacher('${teacher.__backendId}')" class="flex-1 py-3 px-6 rounded-lg font-semibold bg-red-500 text-white hover:bg-red-600 transition-all" style="font-family: ${window.elementSdk?.config?.font_family || defaultConfig.font_family}, sans-serif; font-size: ${window.elementSdk?.config?.font_size || defaultConfig.font_size}px;">‡∏•‡∏ö‡∏Ñ‡∏£‡∏π</button>
          </div>
        </div>
      `);
    }

    async function confirmDeleteTeacher(backendId) {
      const teacher = getTeachers().find(t => t.__backendId === backendId);
      if (!teacher || isLoading) return;
      const confirmBtn = document.querySelector('.modal-overlay button.bg-red-500');
      if (confirmBtn) {
        confirmBtn.innerText = '‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡∏ö...';
        confirmBtn.disabled = true;
        confirmBtn.classList.add('opacity-50', 'cursor-not-allowed');
      }
      isLoading = true;
      const result = await deleteDataFromSheets(teacher);
      isLoading = false;
      if (result.isOk) {
        showToast('‚úÖ ‡∏•‡∏ö‡∏Ñ‡∏£‡∏π‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!');
        closeModal();
      } else {
        showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', 'error');
        if (confirmBtn) {
          confirmBtn.innerText = '‡∏•‡∏ö‡∏Ñ‡∏£‡∏π';
          confirmBtn.disabled = false;
          confirmBtn.classList.remove('opacity-50', 'cursor-not-allowed');
        }
      }
    }

    // Report generation
    function generateReport(type = 'all') {
      const config = window.elementSdk?.config || defaultConfig;
      const bookings = getBookings();
      let reportContent = '';
      if (type === 'all') {
        const bookingsByTeacher = {};
        bookings.forEach(booking => {
          if (!bookingsByTeacher[booking.teacher_name]) {
            bookingsByTeacher[booking.teacher_name] = [];
          }
          bookingsByTeacher[booking.teacher_name].push(booking);
        });
        reportContent = `
          <div class="print-area bg-white p-8">
            <div class="text-center mb-8">
              <h1 class="text-3xl font-bold mb-2" style="font-family: ${config.font_family}, sans-serif;">‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô 411</h1>
              <p class="text-gray-600" style="font-family: ${config.font_family}, sans-serif;">‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÇ‡∏î‡∏¢‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</p>
              <p class="text-gray-500 text-sm" style="font-family: ${config.font_family}, sans-serif;">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô: ${new Date().toLocaleDateString('th-TH')}</p>
            </div>
            <div class="mb-6">
              <h2 class="text-xl font-bold mb-4" style="font-family: ${config.font_family}, sans-serif;">‡∏™‡∏£‡∏∏‡∏õ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°</h2>
              <div class="grid grid-cols-3 gap-4 mb-6">
                <div class="border rounded-lg p-4">
                  <p class="text-gray-600 text-sm" style="font-family: ${config.font_family}, sans-serif;">‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</p>
                  <p class="text-3xl font-bold" style="color: ${config.action_color}; font-family: ${config.font_family}, sans-serif;">${bookings.length}</p>
                </div>
                <div class="border rounded-lg p-4">
                  <p class="text-gray-600 text-sm" style="font-family: ${config.font_family}, sans-serif;">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏£‡∏π</p>
                  <p class="text-3xl font-bold" style="color: ${config.accent_color}; font-family: ${config.font_family}, sans-serif;">${Object.keys(bookingsByTeacher).length}</p>
                </div>
                <div class="border rounded-lg p-4">
                  <p class="text-gray-600 text-sm" style="font-family: ${config.font_family}, sans-serif;">‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</p>
                  <p class="text-3xl font-bold" style="color: #4ade80; font-family: ${config.font_family}, sans-serif;">411</p>
                </div>
              </div>
            </div>
            <div class="mb-6">
              <h2 class="text-xl font-bold mb-4" style="font-family: ${config.font_family}, sans-serif;">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡∏Ñ‡∏£‡∏π</h2>
              ${Object.keys(bookingsByTeacher).map(teacherName => `
                <div class="mb-6 border-b pb-4">
                  <h3 class="font-bold text-lg mb-3" style="color: ${config.action_color}; font-family: ${config.font_family}, sans-serif;">
                    üë®‚Äçüè´ ${teacherName} (${bookingsByTeacher[teacherName].length} ‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á)
                  </h3>
                  <table class="w-full border-collapse">
                    <thead>
                      <tr class="bg-gray-100">
                        <th class="border px-4 py-2 text-left" style="font-family: ${config.font_family}, sans-serif;">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
                        <th class="border px-4 py-2 text-left" style="font-family: ${config.font_family}, sans-serif;">‡∏Ñ‡∏≤‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</th>
                        <th class="border px-4 py-2 text-left" style="font-family: ${config.font_family}, sans-serif;">‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏•‡∏≠‡∏á</th>
                        <th class="border px-4 py-2 text-left" style="font-family: ${config.font_family}, sans-serif;">‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô</th>
                      </tr>
                    </thead>
                    <tbody>
                      ${bookingsByTeacher[teacherName].map(booking => `
                        <tr>
                          <td class="border px-4 py-2" style="font-family: ${config.font_family}, sans-serif;">${booking.date}</td>
                          <td class="border px-4 py-2" style="font-family: ${config.font_family}, sans-serif;">${booking.period}</td>
                          <td class="border px-4 py-2" style="font-family: ${config.font_family}, sans-serif;">${booking.experiment_name}</td>
                          <td class="border px-4 py-2" style="font-family: ${config.font_family}, sans-serif;">‡∏°.${booking.grade}/${booking.room}</td>
                        </tr>
                      `).join('')}
                    </tbody>
                  </table>
                </div>
              `).join('')}
            </div>
          </div>
        `;
      } else {
        const teacherBookings = bookings.filter(b => b.teacher_name === type);
        reportContent = `
          <div class="print-area bg-white p-8">
            <div class="text-center mb-8">
              <h1 class="text-3xl font-bold mb-2" style="font-family: ${config.font_family}, sans-serif;">‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô 411</h1>
              <p class="text-xl font-semibold" style="color: ${config.action_color}; font-family: ${config.font_family}, sans-serif;">üë®‚Äçüè´ ${type}</p>
              <p class="text-gray-500 text-sm" style="font-family: ${config.font_family}, sans-serif;">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô: ${new Date().toLocaleDateString('th-TH')}</p>
            </div>
            <div class="mb-6">
              <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
                <p class="text-gray-600" style="font-family: ${config.font_family}, sans-serif;">‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</p>
                <p class="text-4xl font-bold" style="color: ${config.action_color}; font-family: ${config.font_family}, sans-serif;">${teacherBookings.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</p>
              </div>
            </div>
            <div>
              <h2 class="text-xl font-bold mb-4" style="font-family: ${config.font_family}, sans-serif;">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á</h2>
              <table class="w-full border-collapse">
                <thead>
                  <tr class="bg-gray-100">
                    <th class="border px-4 py-2 text-left" style="font-family: ${config.font_family}, sans-serif;">‡∏•‡∏≥‡∏î‡∏±‡∏ö</th>
                    <th class="border px-4 py-2 text-left" style="font-family: ${config.font_family}, sans-serif;">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
                    <th class="border px-4 py-2 text-left" style="font-family: ${config.font_family}, sans-serif;">‡∏Ñ‡∏≤‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</th>
                    <th class="border px-4 py-2 text-left" style="font-family: ${config.font_family}, sans-serif;">‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏•‡∏≠‡∏á</th>
                    <th class="border px-4 py-2 text-left" style="font-family: ${config.font_family}, sans-serif;">‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô</th>
                  </tr>
                </thead>
                <tbody>
                  ${teacherBookings.map((booking, index) => `
                    <tr>
                      <td class="border px-4 py-2" style="font-family: ${config.font_family}, sans-serif;">${index + 1}</td>
                      <td class="border px-4 py-2" style="font-family: ${config.font_family}, sans-serif;">${booking.date}</td>
                      <td class="border px-4 py-2" style="font-family: ${config.font_family}, sans-serif;">${booking.period}</td>
                      <td class="border px-4 py-2" style="font-family: ${config.font_family}, sans-serif;">${booking.experiment_name}</td>
                      <td class="border px-4 py-2" style="font-family: ${config.font_family}, sans-serif;">‡∏°.${booking.grade}/${booking.room}</td>
                    </tr>
                  `).join('')}
                </tbody>
              </table>
            </div>
          </div>
        `;
      }
      const modal = showModal(`
        <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-4xl w-full mx-4 max-h-screen overflow-y-auto slide-in">
          <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl font-bold" style="color: ${config.text_color}; font-family: ${config.font_family}, sans-serif;">üìä ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á</h2>
            <div class="flex gap-2">
              <button onclick="window.print()" class="px-6 py-2 rounded-lg font-semibold text-white hover:shadow-lg transition-all" style="background: ${config.action_color}; font-family: ${config.font_family}, sans-serif;">üñ®Ô∏è ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</button>
              <button onclick="closeModal()" class="px-6 py-2 rounded-lg font-semibold bg-gray-300 text-gray-700 hover:bg-gray-400 transition-all" style="font-family: ${config.font_family}, sans-serif;">‡∏õ‡∏¥‡∏î</button>
            </div>
          </div>
          ${reportContent}
        </div>
      `);
    }

    // Login page
    function renderLogin() {
      const config = window.elementSdk?.config || defaultConfig;
      const app = document.getElementById('app');
      app.innerHTML = `
        <div class="w-full min-h-screen flex items-center justify-center p-4 relative" style="background: linear-gradient(135deg, ${config.primary_color} 0%, ${config.secondary_color} 100%);">
          <div class="w-full max-w-md bg-white rounded-2xl shadow-2xl p-8 fade-in z-10">
            <div class="text-center mb-8">
              <div class="w-28 h-28 mx-auto mb-4 flex items-center justify-center">
                <img src="https://img5.pic.in.th/file/secure-sv1/fd6b0c3c8fcb90c46b0e373d31838c67.png" alt="Logo" class="w-full h-full object-contain drop-shadow-md">
              </div>
              <h1 class="text-3xl font-bold mb-2" style="color: ${config.text_color}; font-family: ${config.font_family}, sans-serif; font-size: ${config.font_size * 1.875}px;">${config.system_title}</h1>
              <p class="text-lg font-medium text-gray-700 mb-1" style="font-family: ${config.font_family}, sans-serif;">‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏™‡∏≤‡∏£‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå‡πÅ‡∏•‡∏∞‡πÄ‡∏ó‡∏Ñ‡πÇ‡∏ô‡πÇ‡∏•‡∏¢‡∏µ</p>
              <p class="text-base text-gray-600 mb-6" style="font-family: ${config.font_family}, sans-serif;">‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ö‡∏≤‡∏á‡∏™‡∏∞‡∏û‡∏≤‡∏ô‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤ ‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡∏õ‡∏£‡∏∞‡∏à‡∏ß‡∏ö‡∏Ñ‡∏µ‡∏£‡∏µ‡∏Ç‡∏±‡∏ô‡∏ò‡πå</p>
              <p class="text-gray-400 text-sm" style="font-family: ${config.font_family}, sans-serif; font-size: ${config.font_size}px;">${config.login_title}</p>
            </div>
            <div class="space-y-4 mb-6">
              <button onclick="showLoginForm('admin')" class="w-full py-4 px-6 rounded-xl font-semibold text-white transition-all hover:shadow-lg" style="background: ${config.action_color}; font-family: ${config.font_family}, sans-serif; font-size: ${config.font_size}px;">üîê ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô</button>
              <button onclick="showLoginForm('teacher')" class="w-full py-4 px-6 rounded-xl font-semibold transition-all hover:shadow-lg" style="background: ${config.accent_color}; color: white; font-family: ${config.font_family}, sans-serif; font-size: ${config.font_size}px;">üë®‚Äçüè´ ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡∏£‡∏π‡∏ú‡∏π‡πâ‡∏™‡∏≠‡∏ô</button>
            </div>
          </div>
          <div class="absolute bottom-6 w-full text-center">
            <p class="text-gray-500 text-sm font-medium opacity-90" style="font-family: ${config.font_family}, sans-serif;">‡∏û‡∏±‡∏í‡∏ô‡∏≤‡∏£‡∏∞‡∏ö‡∏ö‡πÇ‡∏î‡∏¢ ‡∏Ñ‡∏£‡∏π‡∏≠‡∏≤‡∏ô‡∏ô‡∏ó‡πå ‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡πÅ‡∏Å‡πâ‡∏ß</p>
          </div>
        </div>
      `;
    }

    function showLoginForm(role) {
      const config = window.elementSdk?.config || defaultConfig;
      const app = document.getElementById('app');
      const isAdmin = role === 'admin';
      const teachers = getTeachers();
      app.innerHTML = `
        <div class="w-full min-h-screen flex items-center justify-center p-4" style="background: linear-gradient(135deg, ${config.primary_color} 0%, ${config.secondary_color} 100%);">
          <div class="w-full max-w-md bg-white rounded-2xl shadow-2xl p-8 fade-in">
            <button onclick="renderLogin()" class="mb-4 text-gray-600 hover:text-gray-800 flex items-center" style="font-family: ${config.font_family}, sans-serif; font-size: ${config.font_size * 0.875}px;">‚Üê ‡∏Å‡∏•‡∏±‡∏ö</button>
            <div class="text-center mb-6">
              <h2 class="text-2xl font-bold mb-2" style="color: ${config.text_color}; font-family: ${config.font_family}, sans-serif; font-size: ${config.font_size * 1.5}px;">${isAdmin ? '‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô' : '‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡∏£‡∏π‡∏ú‡∏π‡πâ‡∏™‡∏≠‡∏ô'}</h2>
            </div>
            <form id="loginForm" class="space-y-4">
              ${isAdmin ? `
                <div>
                  <label class="block text-gray-700 mb-2 font-medium" style="font-family: ${config.font_family}, sans-serif; font-size: ${config.font_size}px;">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</label>
                  <input type="text" id="username" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2" style="font-family: ${config.font_family}, sans-serif; font-size: ${config.font_size}px; border-color: ${config.action_color};">
                </div>
                <div>
                  <label class="block text-gray-700 mb-2 font-medium" style="font-family: ${config.font_family}, sans-serif; font-size: ${config.font_size}px;">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</label>
                  <input type="password" id="password" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2" style="font-family: ${config.font_family}, sans-serif; font-size: ${config.font_size}px; border-color: ${config.action_color};">
                </div>
              ` : `
                <div>
                  <label class="block text-gray-700 mb-2 font-medium" style="font-family: ${config.font_family}, sans-serif; font-size: ${config.font_size}px;">Username</label>
                  <input type="text" id="teacherUsername" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2" style="font-family: ${config.font_family}, sans-serif; font-size: ${config.font_size}px; border-color: ${config.action_color};">
                </div>
                <div>
                  <label class="block text-gray-700 mb-2 font-medium" style="font-family: ${config.font_family}, sans-serif; font-size: ${config.font_size}px;">Password</label>
                  <input type="password" id="teacherPassword" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2" style="font-family: ${config.font_family}, sans-serif; font-size: ${config.font_size}px; border-color: ${config.action_color};">
                </div>
              `}
              <button type="submit" class="w-full py-3 px-6 rounded-lg font-semibold text-white transition-all hover:shadow-lg" style="background: ${config.action_color}; font-family: ${config.font_family}, sans-serif; font-size: ${config.font_size}px;">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
            </form>
          </div>
        </div>
      `;
      document.getElementById('loginForm').addEventListener('submit', (e) => {
        e.preventDefault();
        if (isAdmin) {
          const username = document.getElementById('username').value;
          const password = document.getElementById('password').value;
          if (username === ADMIN_USERNAME && password === ADMIN_PASSWORD) {
            currentUser = 'Admin';
            currentRole = 'admin';
            renderDashboard();
            showToast('‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!');
          } else {
            showToast('‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', 'error');
          }
        } else {
          const u = document.getElementById('teacherUsername').value;
          const p = document.getElementById('teacherPassword').value;
          const teacher = teachers.find(t => 
            String(t.teacher_username).trim() === String(u).trim() && 
            String(t.teacher_password).trim() === String(p).trim()
          );
          if (teacher) {
            currentUser = teacher.teacher_name;
            currentRole = 'teacher';
            renderDashboard();
            showToast(`‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö ${teacher.teacher_name}!`);
          } else {
            showToast('Username ‡∏´‡∏£‡∏∑‡∏≠ Password ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', 'error');
          }
        }
      });
    }

    // Teacher Dashboard
    function renderTeacherDashboard() {
      const config = window.elementSdk?.config || defaultConfig;
      const app = document.getElementById('app');
      const bookings = getBookings();
      const currentUserData = currentUser; // ‡πÄ‡∏Å‡πá‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
      
      // ‡∏î‡∏∂‡∏á‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô (‡πÄ‡∏ä‡πá‡∏Ñ‡∏à‡∏≤‡∏Å‡∏ä‡∏∑‡πà‡∏≠)
      const myBookings = bookings.filter(b => b.teacher_name === currentUserData);
      
      const periods = getPeriods();
      const today = new Date();
      const monthDates = Array.from({length: 30}, (_, i) => { 
        const d = new Date(today); 
        d.setDate(today.getDate() + i); 
        return d.toISOString().split('T')[0]; 
      });

      let scheduleGrid = '<div class="overflow-x-auto border rounded-lg"><table class="border-collapse" style="min-width: 2400px;"><thead><tr class="bg-gray-100"><th class="border px-3 py-3 text-left sticky left-0 bg-gray-100 z-10" style="font-family: ' + config.font_family + ', sans-serif; font-size: ' + (config.font_size * 0.875) + 'px; min-width: 120px;">‡∏Ñ‡∏≤‡∏ö/‡∏ß‡∏±‡∏ô</th>';
      monthDates.forEach(date => {
        const d = new Date(date);
        const dayNames = ['‡∏≠‡∏≤', '‡∏à', '‡∏≠', '‡∏û', '‡∏û‡∏§', '‡∏®', '‡∏™'];
        const isWeekend = d.getDay() === 0 || d.getDay() === 6;
        scheduleGrid += `<th class="border px-2 py-3 text-center" style="font-family: ${config.font_family}, sans-serif; font-size: ${config.font_size * 0.75}px; min-width: 80px; ${isWeekend ? 'background: #fee;' : ''}">${dayNames[d.getDay()]}<br><span class="text-xs">${d.getDate()}/${d.getMonth() + 1}</span></th>`;
      });
      scheduleGrid += '</tr></thead><tbody>';

      periods.forEach(period => {
        const periodStr = getFormattedPeriod(period);
        scheduleGrid += `<tr><td class="border px-3 py-2 font-semibold bg-gray-50 sticky left-0 z-10" style="font-family: ${config.font_family}, sans-serif; font-size: ${config.font_size * 0.7}px; min-width: 120px;">${periodStr}</td>`;
        monthDates.forEach(date => {
          
          // ‡πÉ‡∏ä‡πâ checkConflict ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏ß‡πà‡∏≤‡∏ß‡∏±‡∏ô/‡∏Ñ‡∏≤‡∏ö‡∏ô‡∏±‡πâ‡∏ô‡∏°‡∏µ‡πÉ‡∏Ñ‡∏£‡∏à‡∏≠‡∏á ‡∏´‡∏£‡∏∑‡∏≠‡∏°‡∏µ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡πÑ‡∏´‡∏°
          const conflict = checkConflict(date, periodStr, '‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô 411');
          const d = new Date(date);
          const isWeekend = d.getDay() === 0 || d.getDay() === 6;
          
          if (conflict) {
            const isMine = conflict.teacher_name === currentUserData;
            const isFixed = conflict.teacher_name === '‡∏Ñ‡∏£‡∏π‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏´‡πâ‡∏≠‡∏á (‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏™‡∏≠‡∏ô)'; // ‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏¥‡πÄ‡∏®‡∏©‡∏ó‡∏µ‡πà return ‡∏à‡∏≤‡∏Å checkConflict

            if (isFixed) {
               // --- [‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏à‡∏∏‡∏î‡∏ô‡∏µ‡πâ] ‡∏Å‡∏£‡∏ì‡∏µ‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏™‡∏≠‡∏ô‡∏õ‡∏£‡∏∞‡∏à‡∏≥ (‡∏™‡∏µ‡∏™‡πâ‡∏°) ---
               scheduleGrid += `<td class="border px-1 py-2 text-xs align-middle" style="background: #fdba74; font-family: ${config.font_family}, sans-serif; font-size: ${config.font_size * 0.65}px; min-width: 80px;" title="${conflict.experiment_name}">
                  <div class="font-bold text-gray-800 text-center truncate">üîí ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Ñ‡∏£‡∏π‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏´‡πâ‡∏≠‡∏á</div>
               </td>`;
            } else {
               // --- ‡∏Å‡∏£‡∏ì‡∏µ‡∏à‡∏≠‡∏á‡∏õ‡∏Å‡∏ï‡∏¥ (‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô = ‡∏ü‡πâ‡∏≤ / ‡∏Ñ‡∏ô‡∏≠‡∏∑‡πà‡∏ô = ‡πÅ‡∏î‡∏á) ---
               let bgStyle = isMine ? '#bfdbfe' : '#fecaca';
               scheduleGrid += `<td class="border px-1 py-2 text-xs" style="background: ${bgStyle}; font-family: ${config.font_family}, sans-serif; font-size: ${config.font_size * 0.65}px; min-width: 80px;">
                  <div class="font-semibold truncate" title="${conflict.teacher_name}">${conflict.teacher_name.substring(0, 10)}</div>
                  <div class="text-xs truncate" title="${conflict.experiment_name || ''}">${(conflict.experiment_name || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏').substring(0, 12)}</div>
                  <div class="text-xs">‡∏°.${conflict.grade || '-'}/${conflict.room || '-'}</div>
               </td>`;
            }

          } else {
            // ‡∏ß‡πà‡∏≤‡∏á
            scheduleGrid += `<td class="border px-1 py-2 text-center text-gray-400" style="font-family: ${config.font_family}, sans-serif; font-size: ${config.font_size * 0.65}px; min-width: 80px; ${isWeekend ? 'background: #fee;' : ''}">‡∏ß‡πà‡∏≤‡∏á</td>`;
          }
        });
        scheduleGrid += '</tr>';
      });
      scheduleGrid += '</tbody></table></div>';
      
      app.innerHTML = `
        <div class="w-full min-h-screen flex flex-col" style="background: ${config.secondary_color};">
          <div class="w-full px-4 py-6 shadow-md" style="background: linear-gradient(135deg, ${config.primary_color} 0%, ${config.action_color} 100%);">
            <div class="max-w-7xl mx-auto flex justify-between items-center">
              <div>
                <h1 class="text-2xl font-bold text-white mb-1" style="font-family: ${config.font_family}, sans-serif; font-size: ${config.font_size * 1.5}px;">${config.teacher_dashboard_title}</h1>
                <p class="text-white" style="font-family: ${config.font_family}, sans-serif; font-size: ${config.font_size * 0.875}px;">üëã ‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ ${currentUserData}</p>
              </div>
              <div class="flex gap-2">
                <button id="refreshBtn" onclick="refreshData()" class="px-4 py-2 bg-white/20 text-white rounded-lg font-semibold hover:bg-white/30 transition-all border border-white/40 backdrop-blur-sm" style="font-family: ${config.font_family}, sans-serif; font-size: ${config.font_size * 0.875}px;">üîÑ ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä</button>
                <button onclick="logout()" class="px-6 py-2 bg-white rounded-lg font-semibold hover:shadow-lg transition-all" style="color: ${config.action_color}; font-family: ${config.font_family}, sans-serif; font-size: ${config.font_size * 0.875}px;">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
              </div>
            </div>
          </div>
          <div class="max-w-7xl mx-auto p-4 flex-grow w-full">
            <div class="bg-white rounded-2xl shadow-lg p-6 mb-6 slide-in">
              <h2 class="text-xl font-bold mb-4" style="color: ${config.text_color}; font-family: ${config.font_family}, sans-serif; font-size: ${config.font_size * 1.25}px;">üìä ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏´‡πâ‡∏≠‡∏á 411 (30 ‡∏ß‡∏±‡∏ô‡∏Ç‡πâ‡∏≤‡∏á‡∏´‡∏ô‡πâ‡∏≤)</h2>
              
              <div class="mb-3 flex gap-4 flex-wrap">
                <div class="flex items-center gap-2"><div class="w-4 h-4 rounded" style="background: #bfdbfe;"></div><span style="font-family: ${config.font_family}, sans-serif; font-size: ${config.font_size * 0.875}px;">‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</span></div>
                <div class="flex items-center gap-2"><div class="w-4 h-4 rounded" style="background: #fecaca;"></div><span style="font-family: ${config.font_family}, sans-serif; font-size: ${config.font_size * 0.875}px;">‡∏Ñ‡∏£‡∏π‡∏ó‡πà‡∏≤‡∏ô‡∏≠‡∏∑‡πà‡∏ô</span></div>
                
                <div class="flex items-center gap-2"><div class="w-4 h-4 rounded" style="background: #fdba74;"></div><span style="font-family: ${config.font_family}, sans-serif; font-size: ${config.font_size * 0.875}px;">‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Ñ‡∏£‡∏π‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏´‡πâ‡∏≠‡∏á</span></div>
                
                <div class="flex items-center gap-2"><div class="w-4 h-4 rounded" style="background: #fee;"></div><span style="font-family: ${config.font_family}, sans-serif; font-size: ${config.font_size * 0.875}px;">‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î</span></div>
              </div>
              
              <div class="mb-2 text-sm text-gray-600" style="font-family: ${config.font_family}, sans-serif;">üí° ‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÑ‡∏õ‡∏ó‡∏≤‡∏á‡∏Ç‡∏ß‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏ß‡∏±‡∏ô‡∏ñ‡∏±‡∏î‡πÑ‡∏õ</div>
              ${scheduleGrid}
            </div>
            <div class="bg-white rounded-2xl shadow-lg p-6 mb-6 slide-in">
              <h2 class="text-xl font-bold mb-4" style="color: ${config.text_color}; font-family: ${config.font_family}, sans-serif; font-size: ${config.font_size * 1.25}px;">üìù ‡∏à‡∏≠‡∏á‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÉ‡∏´‡∏°‡πà</h2>
              <form id="bookingForm" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div><label class="block text-gray-700 mb-2 font-medium" style="font-family: ${config.font_family}, sans-serif; font-size: ${config.font_size}px;">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label><input type="date" id="bookingDate" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2" style="font-family: ${config.font_family}, sans-serif; font-size: ${config.font_size}px; border-color: ${config.action_color};"></div>
                <div><label class="block text-gray-700 mb-2 font-medium" style="font-family: ${config.font_family}, sans-serif; font-size: ${config.font_size}px;">‡∏Ñ‡∏≤‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</label><select id="bookingPeriod" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2" style="font-family: ${config.font_family}, sans-serif; font-size: ${config.font_size}px; border-color: ${config.action_color};"><option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏≤‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ô --</option>${getPeriods().map(p => `<option value="${getFormattedPeriod(p)}">${getFormattedPeriod(p)}</option>`).join('')}</select></div>
                <div><label class="block text-gray-700 mb-2 font-medium" style="font-family: ${config.font_family}, sans-serif; font-size: ${config.font_size}px;">‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏•‡∏≠‡∏á/‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</label><input type="text" id="experimentName" required placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏•‡∏≠‡∏á‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÅ‡∏£‡∏á" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2" style="font-family: ${config.font_family}, sans-serif; font-size: ${config.font_size}px; border-color: ${config.action_color};"></div>
                <div><label class="block text-gray-700 mb-2 font-medium" style="font-family: ${config.font_family}, sans-serif; font-size: ${config.font_size}px;">‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô</label><select id="bookingGrade" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2" style="font-family: ${config.font_family}, sans-serif; font-size: ${config.font_size}px; border-color: ${config.action_color};"><option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô --</option><option value="1">‡∏°.1</option><option value="2">‡∏°.2</option><option value="3">‡∏°.3</option><option value="4">‡∏°.4</option><option value="5">‡∏°.5</option><option value="6">‡∏°.6</option></select></div>
                <div><label class="block text-gray-700 mb-2 font-medium" style="font-family: ${config.font_family}, sans-serif; font-size: ${config.font_size}px;">‡∏´‡πâ‡∏≠‡∏á</label><input type="text" id="bookingRoom" required placeholder="‡πÄ‡∏ä‡πà‡∏ô 1, 2, 3" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2" style="font-family: ${config.font_family}, sans-serif; font-size: ${config.font_size}px; border-color: ${config.action_color};"></div>
                <div class="flex items-end"><button type="submit" class="w-full py-3 px-6 rounded-lg font-semibold text-white transition-all hover:shadow-lg" style="background: ${config.action_color}; font-family: ${config.font_family}, sans-serif; font-size: ${config.font_size}px;">‡∏à‡∏≠‡∏á‡∏´‡πâ‡∏≠‡∏á</button></div>
              </form>
            </div>
            <div class="bg-white rounded-2xl shadow-lg p-6 slide-in">
              <h2 class="text-xl font-bold mb-4" style="color: ${config.text_color}; font-family: ${config.font_family}, sans-serif; font-size: ${config.font_size * 1.25}px;">üìÖ ‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô (${myBookings.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)</h2>
              <div id="myBookingsList" class="space-y-3">
                ${myBookings.length === 0 ? `<p class="text-gray-500 text-center py-8" style="font-family: ${config.font_family}, sans-serif; font-size: ${config.font_size}px;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á</p>` : myBookings.map(booking => `
                  <div class="booking-card p-4 rounded-lg flex justify-between items-center status-booked">
                    <div style="font-family: ${config.font_family}, sans-serif; font-size: ${config.font_size}px;">
                      <div class="font-semibold" style="color: ${config.text_color};">üî¨ ${booking.experiment_name || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}</div>
                      <div class="text-sm" style="color: ${config.text_color};">üìÖ ${booking.date} | ‚è∞ ${booking.period} | üéì ‡∏°.${booking.grade || '-'}/${booking.room || '-'}</div>
                    </div>
                    <button onclick="deleteBooking('${booking.__backendId}')" class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-all" style="font-family: ${config.font_family}, sans-serif; font-size: ${config.font_size * 0.875}px;">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                  </div>
                `).join('')}
              </div>
            </div>
          </div>
          <div class="w-full text-center py-6 mt-auto"><p class="text-gray-500 text-sm font-medium" style="font-family: ${config.font_family}, sans-serif;">‡∏û‡∏±‡∏í‡∏ô‡∏≤‡∏£‡∏∞‡∏ö‡∏ö‡πÇ‡∏î‡∏¢ ‡∏Ñ‡∏£‡∏π‡∏≠‡∏≤‡∏ô‡∏ô‡∏ó‡πå ‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡πÅ‡∏Å‡πâ‡∏ß</p></div>
        </div>
      `;

      const dateInput = document.getElementById('bookingDate');
      dateInput.min = new Date().toISOString().split('T')[0];

      document.getElementById('bookingForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        if (isLoading || allData.length >= 999) { showToast('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡πÑ‡∏î‡πâ ‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏≤‡∏Å‡∏ñ‡∏∂‡∏á‡∏Ç‡∏µ‡∏î‡∏à‡∏≥‡∏Å‡∏±‡∏î‡πÅ‡∏•‡πâ‡∏ß', 'error'); return; }
        const date = document.getElementById('bookingDate').value;
        const period = document.getElementById('bookingPeriod').value;
        const experimentName = document.getElementById('experimentName').value;
        const grade = document.getElementById('bookingGrade').value;
        const room = document.getElementById('bookingRoom').value;
        
        // ‡πÄ‡∏ä‡πá‡∏Ñ Conflict (‡∏£‡∏ß‡∏°‡∏ñ‡∏∂‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏™‡∏≠‡∏ô‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏î‡πâ‡∏ß‡∏¢)
        const conflict = checkConflict(date, period, '‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô 411');
        if (conflict) { 
            // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏™‡∏≠‡∏ô‡∏õ‡∏£‡∏∞‡∏à‡∏≥ ‡πÉ‡∏´‡πâ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÅ‡∏ö‡∏ö‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏à‡∏≤‡∏∞‡∏à‡∏á
            if (conflict.teacher_name === '‡∏Ñ‡∏£‡∏π‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏´‡πâ‡∏≠‡∏á (‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏™‡∏≠‡∏ô)') {
                showToast(`‚ùå ‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏á: ‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏™‡∏≠‡∏ô‡∏õ‡∏£‡∏∞‡∏à‡∏≥ (${conflict.experiment_name})`, 'error');
            } else {
                showToast(`‚ùå ‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏á: ${conflict.teacher_name} (${conflict.experiment_name})`, 'error'); 
            }
            return; 
        }
        
        isLoading = true;
        const submitBtn = e.target.querySelector('button[type="submit"]');
        submitBtn.disabled = true; submitBtn.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏à‡∏≠‡∏á...';
        const result = await saveDataToSheets({ type: 'booking', booking_id: Date.now().toString(), teacher_name: currentUserData, date, period, lab_name: '‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô 411', experiment_name: experimentName, grade, room, created_at: new Date().toISOString() });
        isLoading = false; submitBtn.disabled = false; submitBtn.textContent = '‡∏à‡∏≠‡∏á‡∏´‡πâ‡∏≠‡∏á';
        if (result.isOk) { showToast('‚úÖ ‡∏à‡∏≠‡∏á‡∏´‡πâ‡∏≠‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!'); e.target.reset(); } else { showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á', 'error'); }
      });
    }

    // Admin Dashboard
    function renderAdminDashboard() {
      const config = window.elementSdk?.config || defaultConfig;
      const app = document.getElementById('app');
      const bookings = getBookings();
      const teachers = getTeachers();
      
      app.innerHTML = `
        <div class="w-full min-h-screen flex flex-col" style="background: ${config.secondary_color};">
          <div class="w-full px-4 py-6 shadow-md" style="background: linear-gradient(135deg, ${config.primary_color} 0%, ${config.action_color} 100%);">
            <div class="max-w-7xl mx-auto flex justify-between items-center">
              <div>
                <h1 class="text-2xl font-bold text-white mb-1" style="font-family: ${config.font_family}, sans-serif; font-size: ${config.font_size * 1.5}px;">${config.admin_dashboard_title}</h1>
                <p class="text-white" style="font-family: ${config.font_family}, sans-serif; font-size: ${config.font_size * 0.875}px;">üîê ‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ ${currentUser}</p>
              </div>
              <div class="flex gap-2">
                <button id="refreshBtn" onclick="refreshData()" class="px-4 py-2 bg-white/20 text-white rounded-lg font-semibold hover:bg-white/30 transition-all border border-white/40 backdrop-blur-sm" style="font-family: ${config.font_family}, sans-serif; font-size: ${config.font_size * 0.875}px;">
                  üîÑ ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä
                </button>
                <button onclick="logout()" class="px-6 py-2 bg-white rounded-lg font-semibold hover:shadow-lg transition-all" style="color: ${config.action_color}; font-family: ${config.font_family}, sans-serif; font-size: ${config.font_size * 0.875}px;">
                  ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö
                </button>
              </div>
            </div>
          </div>

          <div class="max-w-7xl mx-auto p-4 flex-grow w-full">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
              <div class="bg-white rounded-xl shadow-lg p-6 slide-in">
                <div class="flex items-center justify-between">
                  <div><p class="text-gray-600 mb-1" style="font-family: ${config.font_family}, sans-serif; font-size: ${config.font_size * 0.875}px;">‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</p><p class="text-3xl font-bold" style="color: ${config.action_color}; font-family: ${config.font_family}, sans-serif; font-size: ${config.font_size * 1.875}px;">${bookings.length}</p></div>
                  <div class="w-12 h-12 rounded-full flex items-center justify-center" style="background: ${config.action_color};"><span class="text-2xl">üìä</span></div>
                </div>
              </div>
              <div class="bg-white rounded-xl shadow-lg p-6 slide-in">
                <div class="flex items-center justify-between">
                  <div><p class="text-gray-600 mb-1" style="font-family: ${config.font_family}, sans-serif; font-size: ${config.font_size * 0.875}px;">‡∏Ñ‡∏£‡∏π‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</p><p class="text-3xl font-bold" style="color: ${config.accent_color}; font-family: ${config.font_family}, sans-serif; font-size: ${config.font_size * 1.875}px;">${teachers.length}</p></div>
                  <div class="w-12 h-12 rounded-full flex items-center justify-center" style="background: ${config.accent_color};"><span class="text-2xl">üë®‚Äçüè´</span></div>
                </div>
              </div>
              <div class="bg-white rounded-xl shadow-lg p-6 slide-in">
                <div class="flex items-center justify-between">
                  <div><p class="text-gray-600 mb-1" style="font-family: ${config.font_family}, sans-serif; font-size: ${config.font_size * 0.875}px;">‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</p><p class="text-3xl font-bold" style="color: #4ade80; font-family: ${config.font_family}, sans-serif; font-size: ${config.font_size * 1.875}px;">411</p></div>
                  <div class="w-12 h-12 rounded-full flex items-center justify-center" style="background: #4ade80;"><span class="text-2xl">üè´</span></div>
                </div>
              </div>
            </div>

            <div class="bg-white rounded-2xl shadow-lg mb-6">
              <div class="flex border-b overflow-x-auto">
                <button onclick="switchAdminTab('bookings')" class="tab-button px-6 py-4 font-semibold transition-all ${currentAdminTab === 'bookings' ? 'active' : ''}" style="color: ${currentAdminTab === 'bookings' ? config.action_color : config.text_color}; border-color: ${config.action_color}; font-family: ${config.font_family}, sans-serif; font-size: ${config.font_size}px;">üìÖ ‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á</button>
                <button onclick="switchAdminTab('schedule')" class="tab-button px-6 py-4 font-semibold transition-all ${currentAdminTab === 'schedule' ? 'active' : ''}" style="color: ${currentAdminTab === 'schedule' ? config.action_color : config.text_color}; border-color: ${config.action_color}; font-family: ${config.font_family}, sans-serif; font-size: ${config.font_size}px;">üìä ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</button>
                
                <button onclick="switchAdminTab('fixed_schedule')" class="tab-button px-6 py-4 font-semibold transition-all ${currentAdminTab === 'fixed_schedule' ? 'active' : ''}" style="color: ${currentAdminTab === 'fixed_schedule' ? config.action_color : config.text_color}; border-color: ${config.action_color}; font-family: ${config.font_family}, sans-serif; font-size: ${config.font_size}px;">üè´ ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏™‡∏≠‡∏ô‡∏õ‡∏£‡∏∞‡∏à‡∏≥</button>
                
                <button onclick="switchAdminTab('periods')" class="tab-button px-6 py-4 font-semibold transition-all ${currentAdminTab === 'periods' ? 'active' : ''}" style="color: ${currentAdminTab === 'periods' ? config.action_color : config.text_color}; border-color: ${config.action_color}; font-family: ${config.font_family}, sans-serif; font-size: ${config.font_size}px;">‚è∞ ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≤‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</button>
                <button onclick="switchAdminTab('teachers')" class="tab-button px-6 py-4 font-semibold transition-all ${currentAdminTab === 'teachers' ? 'active' : ''}" style="color: ${currentAdminTab === 'teachers' ? config.action_color : config.text_color}; border-color: ${config.action_color}; font-family: ${config.font_family}, sans-serif; font-size: ${config.font_size}px;">üë®‚Äçüè´ ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ñ‡∏£‡∏π</button>
                <button onclick="switchAdminTab('reports')" class="tab-button px-6 py-4 font-semibold transition-all ${currentAdminTab === 'reports' ? 'active' : ''}" style="color: ${currentAdminTab === 'reports' ? config.action_color : config.text_color}; border-color: ${config.action_color}; font-family: ${config.font_family}, sans-serif; font-size: ${config.font_size}px;">üìä ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</button>
              </div>
              <div id="tabContent" class="p-6">${renderAdminTabContent()}</div>
            </div>
          </div>

          <div class="w-full text-center py-6 mt-auto"><p class="text-gray-500 text-sm font-medium" style="font-family: ${config.font_family}, sans-serif;">‡∏û‡∏±‡∏í‡∏ô‡∏≤‡∏£‡∏∞‡∏ö‡∏ö‡πÇ‡∏î‡∏¢ ‡∏Ñ‡∏£‡∏π‡∏≠‡∏≤‡∏ô‡∏ô‡∏ó‡πå ‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡πÅ‡∏Å‡πâ‡∏ß</p></div>
        </div>
      `;
    }

    function renderAdminTabContent() {
      const config = window.elementSdk?.config || defaultConfig;
      const bookings = getBookings();
      const teachers = getTeachers();
      const periods = getPeriods();

      if (currentAdminTab === 'schedule') {
        const today = new Date();
        const monthDates = [];
        for (let i = 0; i < 30; i++) {
          const date = new Date(today);
          date.setDate(today.getDate() + i);
          monthDates.push(date.toISOString().split('T')[0]);
        }

        const fixedSchedules = getFixedSchedules();

        let scheduleGrid = '<div class="overflow-x-auto border rounded-lg"><table class="border-collapse" style="min-width: 2400px;"><thead><tr class="bg-gray-100"><th class="border px-3 py-3 text-left sticky left-0 bg-gray-100 z-10" style="font-family: ' + config.font_family + ', sans-serif; font-size: ' + (config.font_size * 0.875) + 'px; min-width: 120px;">‡∏Ñ‡∏≤‡∏ö/‡∏ß‡∏±‡∏ô</th>';
        
        monthDates.forEach(date => {
          const d = new Date(date);
          const dayNames = ['‡∏≠‡∏≤', '‡∏à', '‡∏≠', '‡∏û', '‡∏û‡∏§', '‡∏®', '‡∏™'];
          const dayName = dayNames[d.getDay()];
          const displayDate = d.getDate() + '/' + (d.getMonth() + 1);
          const isWeekend = d.getDay() === 0 || d.getDay() === 6;
          scheduleGrid += '<th class="border px-2 py-3 text-center" style="font-family: ' + config.font_family + ', sans-serif; font-size: ' + (config.font_size * 0.75) + 'px; min-width: 80px; ' + (isWeekend ? 'background: #fee;' : '') + '">' + dayName + '<br><span class="text-xs">' + displayDate + '</span></th>';
        });
        scheduleGrid += '</tr></thead><tbody>';

        periods.forEach(period => {
          const periodStr = getFormattedPeriod(period);
          scheduleGrid += '<tr><td class="border px-3 py-2 font-semibold bg-gray-50 sticky left-0 z-10" style="font-family: ' + config.font_family + ', sans-serif; font-size: ' + (config.font_size * 0.7) + 'px; min-width: 120px;">' + periodStr + '</td>';
          
          monthDates.forEach(date => {
            const d = new Date(date);
            const dayNames = ['‡∏≠‡∏≤', '‡∏à', '‡∏≠', '‡∏û', '‡∏û‡∏§', '‡∏®', '‡∏™'];
            const currentDayName = dayNames[d.getDay()];
            const isWeekend = d.getDay() === 0 || d.getDay() === 6;

            const booking = bookings.find(b => b.date === date && b.period === periodStr);
            const fixed = fixedSchedules.find(f => f.day_name === currentDayName && f.period_name === periodStr);
            
            if (booking) {
              // ‡∏Å‡∏£‡∏ì‡∏µ‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á (‡∏™‡∏µ‡πÅ‡∏î‡∏á‡∏≠‡πà‡∏≠‡∏ô)
              scheduleGrid += '<td class="border px-1 py-2 text-xs" style="background: #fecaca; font-family: ' + config.font_family + ', sans-serif; font-size: ' + (config.font_size * 0.65) + 'px; min-width: 80px;"><div class="font-semibold truncate" title="' + booking.teacher_name + '">' + booking.teacher_name.substring(0, 10) + '</div><div class="text-xs truncate" title="' + (booking.experiment_name || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏') + '">' + (booking.experiment_name || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏').substring(0, 12) + '</div><div class="text-xs">‡∏°.' + (booking.grade || '-') + '/' + (booking.room || '-') + '</div></td>';
            } else if (fixed) {
              // --- [‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏à‡∏∏‡∏î‡∏ô‡∏µ‡πâ] ‡∏Å‡∏£‡∏ì‡∏µ‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏™‡∏≠‡∏ô‡∏õ‡∏£‡∏∞‡∏à‡∏≥ (‡∏™‡∏µ‡∏™‡πâ‡∏°) ---
              // background: #fdba74 (‡∏™‡∏µ‡∏™‡πâ‡∏°), ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°: üîí ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Ñ‡∏£‡∏π‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏´‡πâ‡∏≠‡∏á
              scheduleGrid += '<td class="border px-1 py-2 text-xs align-middle" style="background: #fdba74; font-family: ' + config.font_family + ', sans-serif; font-size: ' + (config.font_size * 0.65) + 'px; min-width: 80px;" title="' + fixed.description + '"><div class="font-bold text-gray-800 text-center truncate">üîí ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Ñ‡∏£‡∏π‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏´‡πâ‡∏≠‡∏á</div></td>';
            } else {
              // ‡∏Å‡∏£‡∏ì‡∏µ‡∏ß‡πà‡∏≤‡∏á
              scheduleGrid += '<td class="border px-1 py-2 text-center text-gray-400" style="font-family: ' + config.font_family + ', sans-serif; font-size: ' + (config.font_size * 0.65) + 'px; min-width: 80px; ' + (isWeekend ? 'background: #fee;' : '') + '">‡∏ß‡πà‡∏≤‡∏á</td>';
            }
          });
          scheduleGrid += '</tr>';
        });
        scheduleGrid += '</tbody></table></div>';

        return `
          <div class="mb-4">
            <h3 class="text-lg font-bold mb-4" style="color: ${config.text_color}; font-family: ${config.font_family}, sans-serif;">‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏´‡πâ‡∏≠‡∏á 411 (30 ‡∏ß‡∏±‡∏ô‡∏Ç‡πâ‡∏≤‡∏á‡∏´‡∏ô‡πâ‡∏≤)</h3>
            <div class="mb-3 flex gap-4 flex-wrap">
                <div class="flex items-center gap-2">
                  <div class="w-4 h-4 rounded" style="background: #fecaca;"></div>
                  <span style="font-family: ${config.font_family}, sans-serif; font-size: ${config.font_size * 0.875}px;">‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß</span>
                </div>
                <div class="flex items-center gap-2">
                  <div class="w-4 h-4 rounded" style="background: #fdba74;"></div>
                  <span style="font-family: ${config.font_family}, sans-serif; font-size: ${config.font_size * 0.875}px;">‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Ñ‡∏£‡∏π‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏´‡πâ‡∏≠‡∏á</span>
                </div>
                <div class="flex items-center gap-2">
                  <div class="w-4 h-4 rounded" style="background: #fee;"></div>
                  <span style="font-family: ${config.font_family}, sans-serif; font-size: ${config.font_size * 0.875}px;">‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î</span>
                </div>
            </div>
            <div class="mb-2 text-sm text-gray-600" style="font-family: ${config.font_family}, sans-serif;">
                üí° ‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÑ‡∏õ‡∏ó‡∏≤‡∏á‡∏Ç‡∏ß‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏ß‡∏±‡∏ô‡∏ñ‡∏±‡∏î‡πÑ‡∏õ
            </div>
            ${scheduleGrid}
          </div>
        `;
      }
      
      // [‡πÉ‡∏´‡∏°‡πà] ‡∏™‡πà‡∏ß‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Fixed Schedule (‡πÉ‡∏ä‡πâ‡∏î‡∏µ‡πÑ‡∏ã‡∏ô‡πå‡πÄ‡∏î‡∏¥‡∏°)
      else if (currentAdminTab === 'fixed_schedule') {
        const dayNames = ['‡∏à', '‡∏≠', '‡∏û', '‡∏û‡∏§', '‡∏®'];
        const fixedData = getFixedSchedules();
        
        let gridHtml = '<div class="overflow-x-auto"><table class="w-full border-collapse text-center" style="font-family: ' + config.font_family + ', sans-serif;">';
        
        // Header (Periods)
        gridHtml += '<thead><tr class="bg-gray-100"><th class="border p-3 text-left" style="min-width: 100px;">‡∏ß‡∏±‡∏ô / ‡∏Ñ‡∏≤‡∏ö</th>';
        periods.forEach(p => {
           gridHtml += `<th class="border p-3" style="min-width: 120px;">${p.name}<br><span class="text-xs font-normal">${p.time}</span></th>`;
        });
        gridHtml += '</tr></thead><tbody>';

        // Rows (Days)
        dayNames.forEach(day => {
          gridHtml += `<tr><td class="border p-3 font-bold bg-gray-50 text-left">${day}</td>`;
          periods.forEach(p => {
             const periodFormatted = getFormattedPeriod(p);
             const isFixed = fixedData.find(f => f.day_name === day && f.period_name === periodFormatted);
             
             if (isFixed) {
               gridHtml += `
                 <td class="border p-1 bg-red-100 hover:bg-red-200 cursor-pointer transition-colors" onclick="toggleFixedSchedule('${day}', '${periodFormatted}', '${isFixed.__backendId}')">
                    <div class="text-red-600 font-bold text-sm">‚ùå ‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏á</div>
                    <div class="text-xs text-red-500 truncate max-w-[120px] mx-auto">${isFixed.description}</div>
                 </td>
               `;
             } else {
               gridHtml += `
                 <td class="border p-1 hover:bg-green-100 cursor-pointer transition-colors" onclick="toggleFixedSchedule('${day}', '${periodFormatted}', null)">
                    <div class="text-gray-300 text-sm">‡∏ß‡πà‡∏≤‡∏á</div>
                 </td>
               `;
             }
          });
          gridHtml += '</tr>';
        });

        gridHtml += '</tbody></table></div>';

        return `
          <div class="mb-4">
             <h3 class="text-lg font-bold mb-2" style="color: ${config.text_color}; font-family: ${config.font_family}, sans-serif;">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏™‡∏≠‡∏ô‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏´‡πâ‡∏≠‡∏á 411</h3>
             <p class="text-gray-600 mb-4 text-sm" style="font-family: ${config.font_family}, sans-serif;">
               ‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡∏ä‡πà‡∏≠‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏•‡∏±‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ (‡∏ß‡πà‡∏≤‡∏á / ‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏á)<br>
               <span class="text-red-500 font-bold">‡∏™‡∏µ‡πÅ‡∏î‡∏á</span> = ‡∏Ñ‡∏≤‡∏ö‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ô‡∏õ‡∏£‡∏∞‡∏à‡∏≥ (‡∏Ñ‡∏£‡∏π‡∏ó‡πà‡∏≤‡∏ô‡∏≠‡∏∑‡πà‡∏ô‡∏à‡∏≠‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ)<br>
               <span class="text-gray-400">‡∏™‡∏µ‡∏Ç‡∏≤‡∏ß</span> = ‡∏Ñ‡∏≤‡∏ö‡∏ß‡πà‡∏≤‡∏á (‡∏à‡∏≠‡∏á‡πÑ‡∏î‡πâ‡∏õ‡∏Å‡∏ï‡∏¥)
             </p>
             <div class="bg-white rounded-lg border p-4">
                ${gridHtml}
             </div>
          </div>
        `;
      }
      
      else if (currentAdminTab === 'periods') {
        return `
          <div class="mb-4">
            <button onclick="showAddPeriodModal()" class="px-6 py-3 rounded-lg font-semibold text-white transition-all hover:shadow-lg" style="background: ${config.action_color}; font-family: ${config.font_family}, sans-serif; font-size: ${config.font_size}px;">
              ‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏≤‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÉ‡∏´‡∏°‡πà
            </button>
          </div>

          <div class="space-y-3">
            ${periods.length === 0 ? `
              <p class="text-gray-500 text-center py-8" style="font-family: ${config.font_family}, sans-serif; font-size: ${config.font_size}px;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏≤‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö</p>
            ` : periods.map((period, index) => {
              const isDefault = period.id.startsWith('default-');
              return `
                <div class="booking-card p-4 rounded-lg border-l-4" style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border-color: ${config.accent_color};">
                  <div class="flex justify-between items-center">
                    <div style="font-family: ${config.font_family}, sans-serif; font-size: ${config.font_size}px;">
                      <div class="font-semibold text-lg" style="color: ${config.text_color};">
                        ‚è∞ ${period.name}
                        ${isDefault ? '<span class="text-xs bg-gray-200 px-2 py-1 rounded ml-2">‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô</span>' : ''}
                      </div>
                      <div class="text-sm" style="color: ${config.text_color};">
                        üïê ${period.time}
                      </div>
                    </div>
                    ${!isDefault ? `
                      <div class="flex gap-2">
                        <button onclick="showEditPeriodModal('${period.id}')" class="px-4 py-2 rounded-lg font-semibold text-white hover:shadow-lg transition-all" style="background: ${config.action_color}; font-family: ${config.font_family}, sans-serif; font-size: ${config.font_size * 0.875}px;">
                          ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
                        </button>
                        <button onclick="deletePeriod('${period.id}')" class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-all" style="font-family: ${config.font_family}, sans-serif; font-size: ${config.font_size * 0.875}px;">
                          ‡∏•‡∏ö
                        </button>
                      </div>
                    ` : `
                      <div class="text-gray-500 text-sm" style="font-family: ${config.font_family}, sans-serif;">
                        ‡∏Ñ‡∏≤‡∏ö‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô (‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏≤‡∏ö‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà)
                      </div>
                    `}
                  </div>
                </div>
              `;
            }).join('')}
          </div>
        `;
      } else if (currentAdminTab === 'bookings') {
        return `
          <div class="mb-4">
            <input type="text" id="searchInput" placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ï‡∏≤‡∏°‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏£‡∏π ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏•‡∏≠‡∏á..." class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2" style="font-family: ${config.font_family}, sans-serif; font-size: ${config.font_size}px; border-color: ${config.action_color};">
          </div>

          <div id="allBookingsList" class="space-y-3">
            ${bookings.length === 0 ? `
              <p class="text-gray-500 text-center py-8" style="font-family: ${config.font_family}, sans-serif; font-size: ${config.font_size}px;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á</p>
            ` : bookings.map(booking => `
              <div class="booking-card p-4 rounded-lg flex justify-between items-center status-booked">
                <div style="font-family: ${config.font_family}, sans-serif; font-size: ${config.font_size}px;">
                  <div class="font-semibold" style="color: ${config.text_color};">üë®‚Äçüè´ ${booking.teacher_name}</div>
                  <div class="text-sm" style="color: ${config.text_color};">üî¨ ${booking.experiment_name || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'} | üìÖ ${booking.date} | ‚è∞ ${booking.period} | üéì ‡∏°.${booking.grade || '-'}/${booking.room || '-'}</div>
                </div>
                <button onclick="deleteBooking('${booking.__backendId}')" class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-all" style="font-family: ${config.font_family}, sans-serif; font-size: ${config.font_size * 0.875}px;">
                  ‡∏•‡∏ö
                </button>
              </div>
            `).join('')}
          </div>
        `;
      } else if (currentAdminTab === 'teachers') {
        return `
          <div class="mb-4">
            <button onclick="showAddTeacherModal()" class="px-6 py-3 rounded-lg font-semibold text-white transition-all hover:shadow-lg" style="background: ${config.action_color}; font-family: ${config.font_family}, sans-serif; font-size: ${config.font_size}px;">
              ‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏£‡∏π‡πÉ‡∏´‡∏°‡πà
            </button>
          </div>

          <div class="space-y-3">
            ${teachers.length === 0 ? `
              <p class="text-gray-500 text-center py-8" style="font-family: ${config.font_family}, sans-serif; font-size: ${config.font_size}px;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏£‡∏π‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö</p>
            ` : teachers.map(teacher => {
              const teacherBookings = bookings.filter(b => b.teacher_name === teacher.teacher_name);
              return `
                <div class="booking-card p-4 rounded-lg border-l-4" style="background: linear-gradient(135deg, #e0f2fe 0%, #bae6fd 100%); border-color: ${config.action_color};">
                  <div class="flex justify-between items-center">
                    <div style="font-family: ${config.font_family}, sans-serif; font-size: ${config.font_size}px;">
                      <div class="font-semibold text-lg" style="color: ${config.text_color};">üë®‚Äçüè´ ${teacher.teacher_name}</div>
                      <div class="text-sm" style="color: ${config.text_color};">
                        üë§ Username: ${teacher.teacher_username} | üìä ‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á: ${teacherBookings.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
                      </div>
                    </div>
                    <div class="flex gap-2">
                      <button onclick='showEditTeacherModal(${JSON.stringify(teacher)})' class="px-4 py-2 rounded-lg font-semibold text-white hover:shadow-lg transition-all" style="background: ${config.accent_color}; font-family: ${config.font_family}, sans-serif; font-size: ${config.font_size * 0.875}px;">
                        ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
                      </button>
                      <button onclick='deleteTeacher(${JSON.stringify(teacher)})' class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-all" style="font-family: ${config.font_family}, sans-serif; font-size: ${config.font_size * 0.875}px;">
                        ‡∏•‡∏ö
                      </button>
                    </div>
                  </div>
                </div>
              `;
            }).join('')}
          </div>
        `;
      } else if (currentAdminTab === 'reports') {
        const bookingsByTeacher = {};
        bookings.forEach(booking => {
          if (!bookingsByTeacher[booking.teacher_name]) {
            bookingsByTeacher[booking.teacher_name] = [];
          }
          bookingsByTeacher[booking.teacher_name].push(booking);
        });

        return `
          <div class="mb-6">
            <button onclick="generateReport('all')" class="px-6 py-3 rounded-lg font-semibold text-white transition-all hover:shadow-lg" style="background: ${config.action_color}; font-family: ${config.font_family}, sans-serif; font-size: ${config.font_size}px;">
              üìä ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÇ‡∏î‡∏¢‡∏£‡∏ß‡∏°
            </button>
          </div>

          <h3 class="text-lg font-bold mb-4" style="color: ${config.text_color}; font-family: ${config.font_family}, sans-serif; font-size: ${config.font_size * 1.125}px;">‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡∏Ñ‡∏£‡∏π</h3>
          
          <div class="space-y-3">
            ${Object.keys(bookingsByTeacher).length === 0 ? `
              <p class="text-gray-500 text-center py-8" style="font-family: ${config.font_family}, sans-serif; font-size: ${config.font_size}px;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á</p>
            ` : Object.keys(bookingsByTeacher).map(teacherName => `
              <div class="booking-card p-4 rounded-lg border-l-4" style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border-color: ${config.accent_color};">
                <div class="flex justify-between items-center">
                  <div style="font-family: ${config.font_family}, sans-serif; font-size: ${config.font_size}px;">
                    <div class="font-semibold text-lg" style="color: ${config.text_color};">üë®‚Äçüè´ ${teacherName}</div>
                    <div class="text-sm" style="color: ${config.text_color};">
                      üìä ‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: ${bookingsByTeacher[teacherName].length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
                    </div>
                  </div>
                  <button onclick="generateReport('${teacherName}')" class="px-6 py-2 rounded-lg font-semibold text-white hover:shadow-lg transition-all" style="background: ${config.action_color}; font-family: ${config.font_family}, sans-serif; font-size: ${config.font_size * 0.875}px;">
                    üìÑ ‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô
                  </button>
                </div>
              </div>
            `).join('')}
          </div>
        `;
      }
    }

    // [‡πÉ‡∏´‡∏°‡πà - Modal ‡∏û‡∏£‡πâ‡∏≠‡∏° 3 ‡∏ä‡πà‡∏≠‡∏á‡∏Å‡∏£‡∏≠‡∏Å] ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ Fixed Schedule
    function toggleFixedSchedule(dayName, periodName, currentId) {
      if (isLoading) return;
      const config = window.elementSdk?.config || defaultConfig;

      if (currentId) {
        // --- ‡∏Å‡∏£‡∏ì‡∏µ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö (‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Ñ) ---
        showModal(`
          <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full mx-4 slide-in">
            <h2 class="text-2xl font-bold mb-4 text-red-600" style="font-family: ${config.font_family}, sans-serif;">‚ö†Ô∏è ‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Ñ‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h2>
            <p class="mb-6 text-gray-600" style="font-family: ${config.font_family}, sans-serif;">
              ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Ñ <strong>‡∏ß‡∏±‡∏ô${dayName} ${periodName}</strong> ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?
            </p>
            <div class="flex gap-3">
              <button onclick="closeModal()" class="flex-1 py-3 px-6 rounded-lg font-semibold bg-gray-200 text-gray-700 hover:bg-gray-300 transition-all" style="font-family: ${config.font_family}, sans-serif;">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
              <button onclick="confirmDeleteFixed('${currentId}')" class="flex-1 py-3 px-6 rounded-lg font-semibold bg-red-500 text-white hover:bg-red-600 transition-all" style="font-family: ${config.font_family}, sans-serif;">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</button>
            </div>
          </div>
        `);
      } else {
        // --- ‡∏Å‡∏£‡∏ì‡∏µ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏° (‡∏•‡πá‡∏≠‡∏Ñ‡∏´‡πâ‡∏≠‡∏á) - ‡πÅ‡∏ö‡∏ö 3 ‡∏ä‡πà‡∏≠‡∏á‡∏Å‡∏£‡∏≠‡∏Å ---
        showModal(`
          <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full mx-4 slide-in">
            <h2 class="text-2xl font-bold mb-2" style="color: ${config.text_color}; font-family: ${config.font_family}, sans-serif;">üîí ‡∏•‡πá‡∏≠‡∏Ñ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏™‡∏≠‡∏ô‡∏õ‡∏£‡∏∞‡∏à‡∏≥</h2>
            <p class="text-gray-500 mb-6 text-sm" style="font-family: ${config.font_family}, sans-serif;">‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö: ‡∏ß‡∏±‡∏ô${dayName} ${periodName}</p>
            
            <form id="fixedScheduleForm">
              <div class="space-y-4 mb-6">
                <div>
                  <label class="block text-gray-700 mb-2 font-medium" style="font-family: ${config.font_family}, sans-serif;">‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏£‡∏π‡∏ú‡∏π‡πâ‡∏™‡∏≠‡∏ô</label>
                  <input type="text" id="fixedTeacher" required placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏Ñ‡∏£‡∏π‡∏™‡∏°‡∏ä‡∏≤‡∏¢" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2" style="font-family: ${config.font_family}, sans-serif; border-color: ${config.action_color};">
                </div>
                <div>
                  <label class="block text-gray-700 mb-2 font-medium" style="font-family: ${config.font_family}, sans-serif;">‡∏£‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤</label>
                  <input type="text" id="fixedSubject" required placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏ü‡∏¥‡∏™‡∏¥‡∏Å‡∏™‡πå 1" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2" style="font-family: ${config.font_family}, sans-serif; border-color: ${config.action_color};">
                </div>
                <div>
                  <label class="block text-gray-700 mb-2 font-medium" style="font-family: ${config.font_family}, sans-serif;">‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô</label>
                  <input type="text" id="fixedGrade" required placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏°.4/1" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2" style="font-family: ${config.font_family}, sans-serif; border-color: ${config.action_color};">
                </div>
              </div>
              <div class="flex gap-3">
                <button type="button" onclick="closeModal()" class="flex-1 py-3 px-6 rounded-lg font-semibold bg-gray-200 text-gray-700 hover:bg-gray-300 transition-all" style="font-family: ${config.font_family}, sans-serif;">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                <button type="submit" class="flex-1 py-3 px-6 rounded-lg font-semibold text-white transition-all hover:shadow-lg" style="background: ${config.action_color}; font-family: ${config.font_family}, sans-serif;">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
              </div>
            </form>
          </div>
        `);

        // Handle Submit
        document.getElementById('fixedScheduleForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const teacher = document.getElementById('fixedTeacher').value;
            const subject = document.getElementById('fixedSubject').value;
            const grade = document.getElementById('fixedGrade').value;

            // ‡∏£‡∏ß‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏õ‡πá‡∏ô string ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏Å‡πá‡∏ö‡πÉ‡∏ô backend (‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡πÅ‡∏£‡∏Å: ‡∏Ñ‡∏£‡∏π, ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏™‡∏≠‡∏á: ‡∏ß‡∏¥‡∏ä‡∏≤+‡∏ä‡∏±‡πâ‡∏ô)
            const description = `${teacher}\n${subject} (${grade})`;

            closeModal(); 
            isLoading = true; 
            showToast('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...');
            
            await saveDataToSheets({ 
                type: 'fixed_schedule', 
                id: Date.now().toString(), 
                day_name: dayName, 
                period_name: periodName, 
                description: description, 
                created_at: new Date().toISOString() 
            });
            
            isLoading = false; 
            showToast('üîí ‡∏•‡πá‡∏≠‡∏Ñ‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
            renderDashboard();
        });
      }
    }

    async function confirmDeleteFixed(currentId) {
        closeModal(); 
        isLoading = true; 
        showToast('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•...');
        
        await deleteDataFromSheets({ __backendId: currentId });
        
        isLoading = false; 
        showToast('‚úÖ ‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Ñ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
        renderDashboard();
    }

    function switchAdminTab(tab) {
      currentAdminTab = tab;
      renderDashboard();
      
      // Setup search if on bookings tab
      if (tab === 'bookings') {
        setTimeout(() => {
          const searchInput = document.getElementById('searchInput');
          if (searchInput) {
            searchInput.addEventListener('input', (e) => {
              const searchTerm = e.target.value.toLowerCase();
              const filtered = getBookings().filter(booking => 
                booking.teacher_name.toLowerCase().includes(searchTerm) ||
                booking.date.includes(searchTerm) ||
                (booking.experiment_name && booking.experiment_name.toLowerCase().includes(searchTerm))
              );
              
              const config = window.elementSdk?.config || defaultConfig;
              const listEl = document.getElementById('allBookingsList');
              listEl.innerHTML = filtered.length === 0 ? `
                <p class="text-gray-500 text-center py-8" style="font-family: ${config.font_family}, sans-serif; font-size: ${config.font_size}px;">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p>
              ` : filtered.map(booking => `
                <div class="booking-card p-4 rounded-lg flex justify-between items-center status-booked">
                  <div style="font-family: ${config.font_family}, sans-serif; font-size: ${config.font_size}px;">
                    <div class="font-semibold" style="color: ${config.text_color};">üë®‚Äçüè´ ${booking.teacher_name}</div>
                    <div class="text-sm" style="color: ${config.text_color};">üî¨ ${booking.experiment_name || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'} | üìÖ ${booking.date} | ‚è∞ ${booking.period} | üéì ‡∏°.${booking.grade || '-'}/${booking.room || '-'}</div>
                  </div>
                  <button onclick="deleteBooking('${booking.__backendId}')" class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-all" style="font-family: ${config.font_family}, sans-serif; font-size: ${config.font_size * 0.875}px;">
                    ‡∏•‡∏ö
                  </button>
                </div>
              `).join('');
            });
          }
        }, 100);
      }
    }

    // Render dashboard based on role
    function renderDashboard() {
      if (currentRole === 'teacher') {
        renderTeacherDashboard();
      } else if (currentRole === 'admin') {
        renderAdminDashboard();
      }
    }

    // Delete booking
    async function deleteBooking(backendId) {
      const booking = getBookings().find(b => b.__backendId === backendId);
      if (!booking) return;

      const modal = showModal(`
        <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full mx-4 slide-in">
          <h2 class="text-2xl font-bold mb-4 text-red-600" style="font-family: ${window.elementSdk?.config?.font_family || defaultConfig.font_family}, sans-serif;">‚ö†Ô∏è ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</h2>
          <p class="mb-6" style="font-family: ${window.elementSdk?.config?.font_family || defaultConfig.font_family}, sans-serif;">
            ‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á:<br>
            <strong>${booking.experiment_name || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}</strong><br>
            ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${booking.date} ‡∏Ñ‡∏≤‡∏ö ${booking.period}
          </p>
          <div class="flex gap-3">
            <button onclick="closeModal()" class="flex-1 py-3 px-6 rounded-lg font-semibold bg-gray-300 text-gray-700 hover:bg-gray-400 transition-all" style="font-family: ${window.elementSdk?.config?.font_family || defaultConfig.font_family}, sans-serif;">
              ‡∏õ‡∏¥‡∏î
            </button>
            <button id="confirmDeleteBookingBtn" onclick="confirmDeleteBookingAction('${backendId}')" class="flex-1 py-3 px-6 rounded-lg font-semibold bg-red-500 text-white hover:bg-red-600 transition-all" style="font-family: ${window.elementSdk?.config?.font_family || defaultConfig.font_family}, sans-serif;">
              ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
            </button>
          </div>
        </div>
      `);
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ Action ‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á
    async function confirmDeleteBookingAction(backendId) {
      const btn = document.getElementById('confirmDeleteBookingBtn');
      if (btn) {
        btn.disabled = true;
        btn.innerHTML = '‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å...'; // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏≠
        btn.classList.add('opacity-50', 'cursor-not-allowed');
      }

      const booking = getBookings().find(b => b.__backendId === backendId);
      if (booking) {
        const result = await deleteDataFromSheets(booking);
        if (result.isOk) {
          showToast('‚úÖ ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!');
          closeModal();
        } else {
          showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö', 'error');
          if (btn) {
            btn.disabled = false;
            btn.innerHTML = '‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà';
            btn.classList.remove('opacity-50', 'cursor-not-allowed');
          }
        }
      }
    }

    // Logout
    function logout() {
      currentUser = null;
      currentRole = null;
      currentAdminTab = 'bookings';
      renderLogin();
      showToast('‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!');
    }

    // Make functions globally accessible
    window.showLoginForm = showLoginForm;
    window.deleteBooking = deleteBooking;
    window.logout = logout;
    window.switchAdminTab = switchAdminTab;
    window.showAddPeriodModal = showAddPeriodModal;
    window.showEditPeriodModal = showEditPeriodModal;
    window.deletePeriod = deletePeriod;
    window.confirmDeletePeriod = confirmDeletePeriod;
    window.showAddTeacherModal = showAddTeacherModal;
    window.showEditTeacherModal = showEditTeacherModal;
    window.deleteTeacher = deleteTeacher;
    window.confirmDeleteTeacher = confirmDeleteTeacher;
    window.closeModal = closeModal;
    window.generateReport = generateReport;
    
    // [‡πÉ‡∏´‡∏°‡πà] Export
    window.toggleFixedSchedule = toggleFixedSchedule;
    window.confirmDeleteFixed = confirmDeleteFixed;
    window.confirmDeleteBookingAction = confirmDeleteBookingAction;

    // Element SDK config
    async function onConfigChange(config) {
      const systemTitleEl = document.querySelector('h1');
      if (systemTitleEl) {
        systemTitleEl.textContent = config.system_title || defaultConfig.system_title;
        systemTitleEl.style.fontFamily = `${config.font_family || defaultConfig.font_family}, sans-serif`;
      }

      // Update all text elements
      document.querySelectorAll('h1, h2, h3, p, button, label, input, select').forEach(el => {
        el.style.fontFamily = `${config.font_family || defaultConfig.font_family}, sans-serif`;
      });

      // Update colors
      document.querySelectorAll('[style*="background"]').forEach(el => {
        const style = el.getAttribute('style');
        if (style && style.includes('linear-gradient')) {
          el.style.background = `linear-gradient(135deg, ${config.primary_color} 0%, ${config.action_color} 100%)`;
        }
      });
    }

    // Initialize Element SDK
    if (window.elementSdk) {
      window.elementSdk.init({
        defaultConfig,
        onConfigChange,
        mapToCapabilities: (config) => ({
          recolorables: [
            {
              get: () => config.primary_color || defaultConfig.primary_color,
              set: (value) => {
                config.primary_color = value;
                window.elementSdk.setConfig({ primary_color: value });
              }
            },
            {
              get: () => config.secondary_color || defaultConfig.secondary_color,
              set: (value) => {
                config.secondary_color = value;
                window.elementSdk.setConfig({ secondary_color: value });
              }
            },
            {
              get: () => config.text_color || defaultConfig.text_color,
              set: (value) => {
                config.text_color = value;
                window.elementSdk.setConfig({ text_color: value });
              }
            },
            {
              get: () => config.action_color || defaultConfig.action_color,
              set: (value) => {
                config.action_color = value;
                window.elementSdk.setConfig({ action_color: value });
              }
            },
            {
              get: () => config.accent_color || defaultConfig.accent_color,
              set: (value) => {
                config.accent_color = value;
                window.elementSdk.setConfig({ accent_color: value });
              }
            }
          ],
          borderables: [],
          fontEditable: {
            get: () => config.font_family || defaultConfig.font_family,
            set: (value) => {
              config.font_family = value;
              window.elementSdk.setConfig({ font_family: value });
            }
          },
          fontSizeable: {
            get: () => config.font_size || defaultConfig.font_size,
            set: (value) => {
              config.font_size = value;
              window.elementSdk.setConfig({ font_size: value });
            }
          }
        }),
        mapToEditPanelValues: (config) => new Map([
          ['system_title', config.system_title || defaultConfig.system_title],
          ['login_title', config.login_title || defaultConfig.login_title],
          ['teacher_dashboard_title', config.teacher_dashboard_title || defaultConfig.teacher_dashboard_title],
          ['admin_dashboard_title', config.admin_dashboard_title || defaultConfig.admin_dashboard_title]
        ])
      });
    }

    // Initialize app
    async function init() {
      await initializeDataSDK();
      renderLogin();
    }

    init();
  </script>
 </body>
</html>
